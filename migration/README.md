# NetBox migration

Welcome to the documentation of the migration chart for Netbox that uses a
bundle postgresql database.

> **Important**  
> The migration chart only works with a Netbox instance that uses the bundle
> postgresql database.

## Prerequisite
Installing the Bitnami chart repo.

> **Important**  
> Make sure the Bitnami repo is not present under a different name before
> installing it. Having the same repo present multiple time with different names
> will cause issues.
> ```shell
> helm repo list
> ```

```shell
helm repo add bitnami https://charts.bitnami.com/bitnami
```

## TL;DR

For those busy people ðŸ˜‰, here is a short and sweet version of what to do. Fill
the \[blank\] and sit back for a couple of minutes while it setups a new Netbox
instance with the data already migrated for you.

```shell
git clone https://github.com/Kyramee/netbox-openshift.git
./netbox-openshift/migration/script/migration.sh [netboxPassword] [postgresPassword] -r [redisPassword]
```

## Configuration options

This chart has minimal configuration options because all necessary configurations
are already present in the image generated by the netbox-migration project.

| Parameter          | Description                                                                                | Default         |
|--------------------|--------------------------------------------------------------------------------------------|-----------------|
| `job.script`       | Name of the script that the job will execute. (Available options: entrypoint.sh, debug.sh) | `entrypoint.sh` |
| `pvc.storageClass` | StorageClass required by the claim. (Leave empty to use the default storage class)         | `""`            |
| `pvc.accessMode`   | Desired access modes the volume should have                                                | `ReadWriteOnce` |
| `pvc.size`         | Size of the requested volume                                                               | `1Gb`           |



## How does it work
For us, ladies and gentlemen who have a little bit of time on their hands, here
is how the chart works:

### Step one: Installing the migration Chart
The migration helm chart install 4 resources:
- **[Job](templates/job.yaml)**: The Job will fetch a backup of the previous
Netbox instance. This component is dependent on the image generated by the
netbox-migration project.

- **[PVC](templates/pvc.yaml)**: The persistent volume that will hold the Netbox
backup for the new Netbox instance.

- **[ServiceAccount](templates/serviceaccount.yaml)**: The privileged account
that will allow the job to pull the needed image from the netbox-migration
project.

- **[RoleBinding](templates/rolebinding.yaml)**: The configuration that binds
the system:image-puller of the netbox-migration project to the ServiceAccount.

As stated above, the Job depends on an image stored in another project and this
is by design. Using this image, the Job saves a backup of the current Netbox
inside the persistent volume that will then be mounted on the bundle postgresql
container. The image contains the private SSH key needed to connect to the
current Netbox instance. So using a prebuilt image is more secure than having to
regenerate or copying all over the place the private SSH key. 

### Step two: Installing the Netbox chart
After the migration Job has successfully run, the Netbox instance will be
installed with the one caveat that the [postgres value file](posgresql.yaml)
will be included in the installation. This file will override some of the
default configuration of the bundle postgresql chart like adding the volume with
the Netbox backup.

As for the Netbox configuration, a dedicated documentation is available
[here](../netbox/README.md#configuration).

### Step three: Housekeeping
When the Netbox instance is installed, a helm upgrade command without adding the
[postgres value file](posgresql.yaml) will be run in order to remove any
migration configuration from the posgresql pod. Then, all migration resources
installed in step one will be removed and the helm chart uninstalled.

## How does it work, but for dev
Congratulations to all the ladies and gentlemen that made it this far ðŸŽ‰ and, if
you skipped the first "How does it work" section, you are strongly encouraged to
take an extra 5 minutes to read it because some explanations may be unclear
without the added context of the previous sections because this section will
expend the notion seen above with a developer perspective.

### Step one: Installing the migration chart
By default, the helm tool will install the resources in a [predetermine order](https://helm.sh/docs/intro/using_helm/#helm-install-installing-a-package),
but with the help of [hooks](https://helm.sh/docs/topics/charts_hooks/#helm) it
is possible to add a before and after install steps.

Due to some reasons, probably related to the compatibility between Helm and
OpenShift, when some resources are not working as intended when installed in the
same install step. So in order to make everything work together, the migration
helm chart will install 4 resources in this order using hooks:

1. **[ServiceAccount](templates/serviceaccount.yaml)**: Installed in the
"pre-install" step.

2. **[RoleBinding](templates/rolebinding.yaml)**: Installed in the "pre-install"
step.
   > **Important**  
   > The RoleBinding is installed in the **netbox-migration** namespace and not
   > in the current namespace. Read [Allowing pods to reference images across projects](https://docs.openshift.com/container-platform/4.12/openshift_images/managing_images/using-image-pull-secrets.html#images-allow-pods-to-reference-images-across-projects_using-image-pull-secrets)
   > from the OpenShift

3. **[PVC](templates/pvc.yaml)**: Installed in the normal installation step.

4. **[Job](templates/job.yaml)**: Installed in the "post-install" step.

When the helm install command is done, a housekeeping script is generated by the
[NOTES.txt file](templates/NOTES.txt). More details on the script will be given
in step three, but be aware that the script is generated in step one.

### Step two: Installing the Netbox Chart
Since all configurations and technical details are available in the Netbox
chart documentation, there is not much to say here. Just keep in mind that the
[postgres value file](posgresql.yaml) already define some of the value of
postgres chart. If you were to define the same values in another value file,
conflict will arise and one will be overwritten.

### Step three: Housekeeping
Helm uninstall command is limited to namespace where the chart was installed.
Meaning that any resources installed in another namespace will not be removed.

In order to facilitate the housekeeping step, a label named housekeeping with a
20 random characters long string as value is added to all resources. This label
will be used as a selector to delete all migration resources with the script
generated by the [NOTES.txt](templates/NOTES.txt) template. The housekeeping
label value must be unique in order to avoid deleting unrelated resources with
the same housekeeping label.